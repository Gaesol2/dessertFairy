<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "com.shop.dessertFairy.review.dao.ReviewDAO">
	<select id="getReviewCnt" resultType="int">
		SELECT COUNT(R_NO) FROM REVIEW
	</select>
   <insert id="reviewWrite" parameterType="rdto">
   <selectKey keyProperty="r_no" order="BEFORE" resultType="int">
		SELECT NVL(MAX(R_NO),0)+1 FROM REVIEW
	</selectKey>
      INSERT INTO REVIEW(
         R_NO
         ,R_SUBJECT
         ,R_CONTENT
         ,R_REGDATE
         ,R_READCOUNT
         ,R_PASSWD
         ,R_STAR
         ,R_IMAGE
         ,R_PATH
         ,M_ID)
      VALUES(
          #{r_no       }
         ,#{r_subject  }
         ,#{r_content  }
         ,SYSDATE
         ,0
         ,#{r_passwd   }
         ,#{r_star     }
         ,#{r_image    }
         ,#{r_path    }
         ,#{m_id       }
      )
   </insert>
   
   <insert id="replyWrite" parameterType="rdto">
      INSERT INTO REVIEW(
         R_REPLY)
      VALUES(#{r_reply})
   </insert>
   
   <select id="getReviewList" resultType="rdto">
		SELECT * FROM 
       (SELECT ROWNUM AS R_RR, A.* 
        FROM 
		(SELECT R_NO
			   ,R_SUBJECT
			   ,R_CONTENT
			   ,TO_CHAR(R_REGDATE,'YYYY-MM-DD') AS R_REGDATE
			   ,R_READCOUNT
			   ,R_PASSWD
			   ,R_STAR
			   ,R_IMAGE
			   ,M_ID
			   ,R_PATH
		FROM REVIEW
	  ORDER BY R_NO ASC) A)
     WHERE R_RR BETWEEN #{start,jdbcType=NUMERIC} and #{end,jdbcType=NUMERIC}
	</select>
	
   <select id="getReplyList" resultType="rdto">
		SELECT * FROM 
       (SELECT ROWNUM AS R_RR, A.* 
        FROM 
		(SELECT R_NO
			   ,R_SUBJECT
			   ,R_CONTENT
			   ,TO_CHAR(R_REGDATE,'YYYY-MM-DD') AS R_REGDATE
			   ,R_READCOUNT
			   ,R_PASSWD
			   ,R_STAR
			   ,R_IMAGE
			   ,M_ID
			   ,R_PATH
		FROM REVIEW
	  ORDER BY R_NO ASC) A)
     WHERE R_RR BETWEEN #{start,jdbcType=NUMERIC} and #{end,jdbcType=NUMERIC}
	</select>
   <select id="getReviewMyList" resultType="rdto">
		SELECT * FROM 
       (SELECT ROWNUM AS R_RR, A.* 
        FROM 
		(SELECT R_NO
			   ,R_SUBJECT
			   ,R_CONTENT
			   ,TO_CHAR(R_REGDATE,'YYYY-MM-DD') AS R_REGDATE
			   ,R_READCOUNT
			   ,R_PASSWD
			   ,R_STAR
			   ,R_IMAGE
			   ,M_ID
			   ,R_PATH
		FROM REVIEW
	  ORDER BY R_NO ASC) A)
     WHERE M_ID = #{m_id}
	</select>

   <select id="getReviewListOrderby" parameterType="map" resultType="rdto">
		SELECT R_NO
			   ,R_SUBJECT
			   ,R_CONTENT
			   ,TO_CHAR(R_REGDATE,'YYYY-MM-DD') AS R_REGDATE
			   ,R_READCOUNT
			   ,R_PASSWD
			   ,R_STAR
			   ,R_IMAGE
			   ,M_ID
			   ,R_PATH
		FROM REVIEW
		<if test='orderby.equals("old")'>
		  ORDER BY R_NO DESC
		</if>
		<if test='orderby.equals("star")'>
		  ORDER BY R_STAR DESC
		</if>
		<if test='orderby.equals("read")'>
		  ORDER BY R_READCOUNT DESC
		</if>
	</select>
	
	<update id="updateReadCnt" parameterType="rdto">
   UPDATE REVIEW SET R_READCOUNT = R_READCOUNT+1
   WHERE R_NO = #{r_no}
   </update>
</mapper>